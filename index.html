<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAMA V.2 - Professional AI Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', 'Noto Sans Thai', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { overflow: hidden; position: fixed; width: 100%; height: 100%; background-color: #f1f5f9; color: #1e293b; }
        #root { position: fixed; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden; display: flex; flex-direction: column; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .input-focus:focus { border-color: #0ea5e9 !important; ring: 2px rgba(14, 165, 233, 0.1); outline: none; }
        .fixed-height { height: 100vh; height: 100dvh; }
        .nav-active { background: #f0f9ff; color: #0284c7; border-right: 4px solid #0284c7; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <div id="root" class="fixed-height"></div>

    <script>
        const SUPABASE_URL = "https://wmgrfwvlrdbfmqngtuuq.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZ3Jmd3ZscmRiZm1xbmd0dXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NTU4MjYsImV4cCI6MjA4NTEzMTgyNn0.l-VMPuCfL69hcHAyd3Nw3pi1HUPlGV2Iz7AuTEO2sU4";

        const REGIONAL_DATA = {
            "RH1": { name: "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø & ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•", zones: ["‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£", "‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥", "‡∏™‡∏≤‡∏ó‡∏£", "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó"], hospitals: ["‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå", "‡∏™‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏ß‡∏ä"], keywords: ["‡πÄ‡∏£‡πà‡∏á‡∏£‡∏µ‡∏ö", "‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏π‡∏á"] },
            "RH2": { name: "‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", zones: ["‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤", "‡∏û‡∏±‡∏ó‡∏¢‡∏≤", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á"], hospitals: ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏û‡∏±‡∏ó‡∏¢‡∏≤", "‡∏û‡∏ç‡∏≤‡πÑ‡∏ó‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤"], keywords: ["‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°", "‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤"] },
            "RH3": { name: "‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", zones: ["‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤"], hospitals: ["‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≤‡∏°", "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"], keywords: ["‡∏™‡∏∏‡∏†‡∏≤‡∏û", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå"] },
            "RH4": { name: "‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô", zones: ["‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ"], hospitals: ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡πÄ‡∏≠‡∏Å‡∏≠‡∏∏‡∏î‡∏£"], keywords: ["‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á", "‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á"] },
            "RH5": { name: "‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ", zones: ["‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà"], hospitals: ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà", "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï"], keywords: ["‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à", "‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"] }
        };

        class MAMAV2 {
            constructor() {
                this.state = {
                    apiKey: "",
                    isSetup: false,
                    userProfile: { rh: "", zone: "" },
                    activeTab: "ice_breaking",
                    loading: false,
                    aiResponse: "",
                    error: "",
                    forms: {
                        ice_breaking: { transaction: "‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥", observation: "", disc: "S", relationship: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà" },
                        needs_analysis: { income: "50,000", debt: "1,000,000", tax_bracket: "10%", welfare: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°", hospital_type: "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≥", retirement_goal: "30,000", dependents: "1", years: "20", concern: "‡∏Å‡∏•‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏±‡∏á‡πÅ‡∏ï‡∏Å" },
                        objection: { reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á", product: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢", tone: "‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏ï‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò", disc: "C", interest_level: "5" },
                        prompt_library: { objective: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå Facebook ‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô", target: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà", style: "Emotional & Storytelling" }
                    }
                };
                this.init();
            }

            async init() {
                await this.fetchApiKey();
                this.render();
            }

            async fetchApiKey() {
                try {
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/api_configs?select=key&active=eq.true&limit=1`, {
                        headers: { "apikey": SUPABASE_ANON_KEY, "Authorization": `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    const data = await res.json();
                    if (data?.[0]?.key) this.state.apiKey = data[0].key;
                } catch (e) { console.error("Supabase error", e); }
            }

                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á Context ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ
            getRegionalContext() {
                const rhKey = this.state.userProfile.rh;
                const data = REGIONAL_DATA[rhKey];
                return data ? `‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:${data.name} (‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${data.keywords.join(", ")}) ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:${data.hospitals.join(", ")}` : "";
            }

            getPrompt() {
                const zone = this.state.userProfile.zone;
                const regionInfo = this.getRegionalContext();
                const f = this.state.forms;

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á AI ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
                const basePersona = `
                Role: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á (Senior Financial Advisor) ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≥
                Tone: ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û, ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à, ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö, ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à (Empathy)
                Constraint: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏¢‡∏±‡∏î‡πÄ‡∏¢‡∏µ‡∏¢‡∏î (No Hard Sell), ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏û‡∏π‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (Spoken Language)`;

                switch(this.state.activeTab) {
                    case "ice_breaking":
                        return `
                        ${basePersona}
                        Task: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" (Ice Breaking) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô
                        
                        [Customer Data]
                        - Transaction: ‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° "${f.ice_breaking.transaction}"
                        - Context: ${regionInfo}, ‡πÇ‡∏ã‡∏ô ${zone}
                        - Observation: ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏∑‡∏≠ "${f.ice_breaking.observation}"
                        - DISC Profile: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πÑ‡∏ï‡∏•‡πå "${f.ice_breaking.disc}" (
                            ${f.ice_breaking.disc === 'D' ? '‡πÄ‡∏ô‡πâ‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô ‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏ó‡∏∏‡πà‡∏á' : 
                              f.ice_breaking.disc === 'I' ? '‡∏ä‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏¢‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÄ‡∏ô‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®' : 
                              f.ice_breaking.disc === 'S' ? '‡∏ä‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏ä‡πâ‡∏≤‡πÜ ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• ‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏î‡∏±‡∏ô' : 
                              '‡∏ä‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à'}
                        )

                        [Instruction]
                        1. Small Talk: ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å "Observation" ‡∏´‡∏£‡∏∑‡∏≠ "Transaction" ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÉ‡∏™‡πà‡πÉ‡∏à
                        2. Bridging: ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ "Contextual Bridge" ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
                        3. Power Question: ‡∏à‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏≤‡∏ï‡πà‡∏≠

                        Output Format (‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢):
                        - üß† **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏Å‡∏°:** (‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)
                        - üó£Ô∏è **‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à:** (‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏Ñ‡∏≥‡∏û‡∏π‡∏î)
                        - üéØ **‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á:** (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏î)
                        `;

                    case "needs_analysis":
                        return `
                        ${basePersona}
                        Task: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏õ‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (Risk Audit & Solution)
                        
                        [Financial Health]
                        - ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${f.needs_analysis.income} | ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô: ${f.needs_analysis.debt}
                        - ‡∏†‡∏≤‡∏©‡∏µ: ${f.needs_analysis.tax_bracket} | ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£: ${f.needs_analysis.welfare}
                        - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Pain Point): "${f.needs_analysis.concern}"
                        - ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${regionInfo} (‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÉ‡∏ô ‡∏£‡∏û. ‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≥)

                        [Instruction]
                        1. ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ "Financial Gap Analysis" ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢ (Protection Gap)
                        2. ‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏• (Pain Point) ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (Fear of Loss) ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Ç‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ß‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
                        3. ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ Solution ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à" ‡πÅ‡∏•‡∏∞ "‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á" ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô

                        Output Format:
                        - üö® **Risk Audit Result:** (‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏ô 3 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
                        - üè• **Reality Check:** (‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô ‡∏£‡∏û. ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ)
                        - üó£Ô∏è **‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠:** (‡∏ö‡∏ó‡∏û‡∏π‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô Storytelling ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö Pain Point)
                        `;

                    case "objection":
                        return `
                        ${basePersona}
                        Task: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (Objection Handling) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™
                        
                        [Situation]
                        - ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏û‡∏£‡∏≤‡∏∞: "${f.objection.reason}"
                        - ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠: "${f.objection.product}"
                        - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏î‡∏¥‡∏°: ${f.objection.interest_level}/10
                        - ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${f.ice_breaking.disc || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}

                        [Instruction]
                        ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ **LSCPA Model**:
                        1. Listen & Share (‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à): ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ "Feel-Felt-Found"
                        2. Clarify (‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°): ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏á
                        3. Present (‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡∏°‡πà): ‡πÉ‡∏´‡πâ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (Reframe) ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                        4. Ask (‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢): ‡∏Ç‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏î‡∏π‡πÅ‡∏•

                        Output Format:
                        - üõ°Ô∏è **‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠:** (‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
                        - üó£Ô∏è **‡∏ö‡∏ó‡∏û‡∏π‡∏î‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á:** (‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ï‡∏≤‡∏° LSCPA Model)
                        - ü§ù **‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:** (‡πÄ‡∏™‡∏ô‡∏≠ 2 ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Two-Option Close)
                        `;

                    case "prompt_library":
                        return `
                        Role: Expert AI Prompt Engineer
                        Task: ‡∏™‡∏£‡πâ‡∏≤‡∏á "Mega Prompt" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Generative AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: "${f.prompt_library.objective}"
                        Target Audience: ${f.prompt_library.target}
                        Tone/Style: ${f.prompt_library.style}
                        
                        Output Format:
                        - ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Prompt
                        - Code Block ‡∏ó‡∏µ‡πà‡∏°‡∏µ Prompt ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        `;
                }
            }


            async handleGenerate() {
                if (!this.state.apiKey) { this.setState({ error: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö API..." }); return; }
                this.setState({ loading: true, aiResponse: "", error: "" });
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.state.apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: this.getPrompt() }] }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    this.setState({ aiResponse: data.candidates[0].content.parts[0].text, loading: false });
                } catch (err) { this.setState({ error: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + err.message, loading: false }); }
            }

            render() {
                const root = document.getElementById('root');
                root.innerHTML = !this.state.isSetup ? this.renderSetup() : this.renderMain();
            }

            renderSetup() {
                return `
                <div class="fixed-height flex items-center justify-center p-6 bg-slate-50">
                    <div class="bg-white rounded-[2rem] p-8 w-full max-w-md shadow-xl border border-slate-100 animate-in">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-sky-500 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg shadow-sky-200">
                                <i class="fas fa-robot text-3xl"></i>
                            </div>
                            <h1 class="text-2xl font-black text-slate-800 tracking-tight">MAMA <span class="text-sky-500">V.2</span></h1>
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">Professional Assistant</p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                                <select id="setup-rh" class="w-full p-4 rounded-xl border border-slate-200 mt-1 font-bold text-slate-700 bg-slate-50" onchange="window.app.onRHChange(this.value)">
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å RH</option>
                                    ${Object.keys(REGIONAL_DATA).map(k => `<option value="${k}">${k}: ${REGIONAL_DATA[k].name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">‡πÇ‡∏ã‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
                                <select id="setup-zone" class="w-full p-4 rounded-xl border border-slate-200 mt-1 font-bold text-slate-700 bg-slate-50">
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</option>
                                </select>
                            </div>
                            <button onclick="window.app.completeSetup()" class="w-full bg-sky-500 text-white py-4 rounded-2xl font-black text-lg mt-4 hover:bg-sky-600 transition-all shadow-lg shadow-sky-100 active:scale-95">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                        </div>
                    </div>
                </div>`;
            }

            renderMain() {
                return `
                <div class="fixed-height flex flex-col md:flex-row bg-white">
                    <!-- Sidebar -->
                    <aside class="w-full md:w-64 bg-slate-50 border-r border-slate-200 flex flex-col">
                        <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                            <span class="font-black text-xl text-slate-800">MAMA <span class="text-sky-500">PRO</span></span>
                            <span class="w-2 h-2 rounded-full bg-sky-500 animate-pulse"></span>
                        </div>
                        <nav class="flex-1 py-4 overflow-y-auto">
                            ${this.navItem('ice_breaking', 'fa-comments', '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à (Ice Breaking)')}
                            ${this.navItem('needs_analysis', 'fa-chart-simple', '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£')}
                            ${this.navItem('objection', 'fa-shield-heart', '‡∏ó‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á')}
                            ${this.navItem('prompt_library', 'fa-wand-magic-sparkles', '‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á AI')}
                        </nav>
                        <div class="p-4 border-t border-slate-200">
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                                <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Current Profile</p>
                                <p class="text-xs font-bold text-slate-700 truncate">${this.state.userProfile.zone} (${this.state.userProfile.rh})</p>
                            </div>
                        </div>
                    </aside>

                    <!-- Content Area -->
                    <main class="flex-1 flex flex-col overflow-hidden bg-white">
                        <header class="h-16 border-b border-slate-100 px-6 flex items-center justify-between bg-white/80 backdrop-blur-md z-10">
                            <h2 class="font-bold text-slate-800">${this.getTabLabel()}</h2>
                            <button onclick="window.app.handleGenerate()" ${this.state.loading ? 'disabled' : ''} class="bg-sky-500 text-white px-5 py-2 rounded-xl font-bold text-sm shadow-lg shadow-sky-100 flex items-center gap-2 active:scale-95 transition-all">
                                ${this.state.loading ? '<i class="fas fa-spinner fa-spin"></i>' : '<i class="fas fa-bolt"></i>'} AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                            </button>
                        </header>

                        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                            <!-- Inputs -->
                            <div class="w-full lg:w-80 border-r border-slate-50 overflow-y-auto p-6 custom-scrollbar bg-white">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                                <div class="space-y-1">
                                    ${this.renderActiveForm()}
                                </div>
                            </div>

                            <!-- Results -->
                            <div class="flex-1 overflow-y-auto p-6 lg:p-10 bg-slate-50 custom-scrollbar">
                                ${this.state.error ? `<div class="p-4 bg-red-50 text-red-500 rounded-xl border border-red-100 text-xs mb-6 animate-in">${this.state.error}</div>` : ''}
                                ${this.state.aiResponse ? 
                                    `<div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 animate-in leading-relaxed text-slate-700">
                                        <div class="flex items-center gap-2 mb-6 text-sky-500">
                                            <i class="fas fa-lightbulb"></i>
                                            <span class="text-[10px] font-black uppercase tracking-[0.2em]">AI Strategic Advice</span>
                                        </div>
                                        <div class="space-y-4">
                                            ${this.formatText(this.state.aiResponse)}
                                        </div>
                                    </div>` : 
                                    `<div class="h-full flex flex-col items-center justify-center opacity-30">
                                        <i class="fas fa-brain text-6xl text-slate-200 mb-4"></i>
                                        <p class="text-sm font-bold text-slate-400 uppercase tracking-widest">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                                    </div>`
                                }
                                <div class="h-20"></div>
                            </div>
                        </div>
                    </main>
                </div>`;
            }

            navItem(id, icon, label) {
                const active = this.state.activeTab === id;
                return `<button onclick="window.app.switchTab('${id}')" class="w-full flex items-center gap-3 px-6 py-4 text-sm font-bold transition-all ${active ? 'nav-active' : 'text-slate-400 hover:bg-slate-100 hover:text-slate-600'}">
                    <i class="fas ${icon} w-5"></i><span>${label}</span>
                </button>`;
            }

            renderActiveForm() {
                const f = this.state.forms[this.state.activeTab];
                const input = "w-full p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm mb-4 input-focus font-medium text-slate-700";
                const label = "text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-1 block";

                switch(this.state.activeTab) {
                    case "ice_breaking":
                        return `
                        <label class="${label}">‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</label>
                        <select onchange="window.app.updateForm('transaction', this.value)" class="${input}">
                            <option>‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥</option><option>‡∏°‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏∏‡∏î</option><option>‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
                        </select>
                        <label class="${label}">‡∏™‡∏¥‡πà‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (Insight)</label>
                        <textarea placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏≤‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πá‡∏Å, ‡∏î‡∏π‡∏´‡πà‡∏ß‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß..." oninput="window.app.updateForm('observation', this.value)" class="${input} h-24">${f.observation}</textarea>
                        <label class="${label}">‡∏à‡∏£‡∏¥‡∏ï‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (DISC)</label>
                        <select onchange="window.app.updateForm('disc', this.value)" class="${input}">
                            <option value="D">D - ‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</option><option value="I">I - ‡∏ä‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏¢</option><option value="S" selected>S - ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á</option><option value="C">C - ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>
                        </select>`;
                    case "needs_analysis":
                        return `
                        <label class="${label}">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ / ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</label>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <input type="text" value="${f.income}" placeholder="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ" oninput="window.app.updateForm('income', this.value)" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 text-xs">
                            <input type="text" value="${f.debt}" placeholder="‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô" oninput="window.app.updateForm('debt', this.value)" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 text-xs">
                        </div>
                        <label class="${label}">‡∏ê‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ</label>
                        <select onchange="window.app.updateForm('tax_bracket', this.value)" class="${input}">
                            <option>‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</option><option>10%</option><option>20%</option><option>30%</option>
                        </select>
                        <label class="${label}">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                        <input type="text" value="${f.welfare}" oninput="window.app.updateForm('welfare', this.value)" class="${input}">
                        <label class="${label}">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏´‡∏•‡∏±‡∏Å</label>
                        <select onchange="window.app.updateForm('concern', this.value)" class="${input}">
                            <option>‡∏Å‡∏•‡∏±‡∏ß‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏¢</option><option selected>‡∏Å‡∏•‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏±‡∏á‡πÅ‡∏ï‡∏Å</option><option>‡∏Å‡∏•‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà</option>
                        </select>`;
                    case "objection":
                        return `
                        <label class="${label}">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</label>
                        <select onchange="window.app.updateForm('reason', this.value)" class="${input}">
                            <option>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á</option><option>‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</option><option>‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ó‡∏¥‡πâ‡∏á‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤</option><option>‡∏Ç‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á</option>
                        </select>
                        <label class="${label}">‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠</label>
                        <input type="text" value="${f.product}" oninput="window.app.updateForm('product', this.value)" class="${input}">
                        <label class="${label}">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à (1-10)</label>
                        <input type="range" min="1" max="10" value="${f.interest_level}" oninput="window.app.updateForm('interest_level', this.value)" class="w-full mb-4">`;
                    case "prompt_library":
                        return `
                        <label class="${label}">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
                        <input type="text" value="${f.objective}" oninput="window.app.updateForm('objective', this.value)" class="${input}">
                        <label class="${label}">‡∏™‡πÑ‡∏ï‡∏•‡πå</label>
                        <select onchange="window.app.updateForm('style', this.value)" class="${input}">
                            <option>Emotional & Storytelling</option><option>Professional & Logic</option><option>Urgency</option>
                        </select>`;
                }
            }

            getTabLabel() {
                const map = { ice_breaking:'Psychological Opener', needs_analysis:'Deep Risk Auditor', objection:'Objection Reframer', prompt_library:'Prompt Architect' };
                return map[this.state.activeTab];
            }

            onRHChange(rh) {
                const z = document.getElementById('setup-zone');
                if (!z) return;
                z.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</option>';
                if (REGIONAL_DATA[rh]) REGIONAL_DATA[rh].zones.forEach(i => z.innerHTML += `<option value="${i}">${i}</option>`);
            }

            completeSetup() {
                const rh = document.getElementById('setup-rh').value;
                const zone = document.getElementById('setup-zone').value;
                if (!rh || !zone) return;
                this.state.userProfile = { rh, zone };
                this.state.isSetup = true;
                this.render();
            }

            switchTab(t) { this.state.activeTab = t; this.state.aiResponse = ""; this.state.error = ""; this.render(); }
            updateForm(f, v) { this.state.forms[this.state.activeTab][f] = v; }
            formatText(t) {
                return t.replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-900 font-bold">$1</strong>')
                        .replace(/### (.*?)(<br>|$)/g, '<h3 class="text-sky-600 font-black text-lg mt-6 mb-2">$1</h3>')
                        .replace(/```(.*?)```/gs, '<div class="bg-slate-50 p-4 rounded-xl border border-slate-200 font-mono text-xs my-4 overflow-x-auto text-sky-700">$1</div>');
            }
            setState(n) { this.state = { ...this.state, ...n }; this.render(); }
        }

        window.app = new MAMAV2();
    </script>
</body>
</html>

