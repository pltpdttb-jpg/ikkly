<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAMA V.2 - AI Sale Assistant</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons CDN -->
    <script type="module">
        import { 
            Users, MapPin, Calculator, MessageSquare, ShieldAlert, Gift, 
            ShoppingBag, FileCheck, Terminal, ChevronRight, Sparkles, 
            Target, Heart, Share2, Save, ThumbsUp, ThumbsDown, 
            ArrowRight, Copy, Loader2, RotateCcw, Building2, Stethoscope, 
            Lightbulb, Zap, TrendingUp, AlertCircle 
        } from 'https://unpkg.com/lucide@0.263.0/dist/esm/lucide.js';
        
        window.lucide = {
            Users, MapPin, Calculator, MessageSquare, ShieldAlert, Gift,
            ShoppingBag, FileCheck, Terminal, ChevronRight, Sparkles,
            Target, Heart, Share2, Save, ThumbsUp, ThumbsDown,
            ArrowRight, Copy, Loader2, RotateCcw, Building2, Stethoscope,
            Lightbulb, Zap, TrendingUp, AlertCircle
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            --dark-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .animate-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        
        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background: #94a3b8;
        }
        
        .slide-in-from-bottom {
            animation: slideInFromBottom 0.5s ease-out;
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            ring: 2px;
            ring-color: #0ea5e9;
            border-color: #0ea5e9;
        }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root" class="min-h-screen"></div>
    
    <script type="module">
        // ตั้งค่า Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans Thai', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'spin': 'spin 1s linear infinite',
                    }
                }
            }
        };

        const { 
            Users, MapPin, Calculator, MessageSquare, ShieldAlert, Gift,
            ShoppingBag, FileCheck, Terminal, ChevronRight, Sparkles,
            Target, Heart, Share2, Save, ThumbsUp, ThumbsDown,
            ArrowRight, Copy, Loader2, RotateCcw, Building2, Stethoscope,
            Lightbulb, Zap, TrendingUp, AlertCircle 
        } = window.lucide;

        // --- Enhanced Regional Data Schema ---
        const RH_DATA = {
            "RH1": {
                name: "RH1: กรุงเทพฯ & ปริมณฑล",
                dynamics: "สังคมเมือง เร่งรีบ แข่งขันสูง ค่าครองชีพสูงที่สุด",
                keywords: ["ภาษีสังคม", "ค่าเสียเวลา", "ความคุ้มครองระดับพรีเมียม", "มรดกที่จับต้องได้"],
                hospitals: ["บำรุงราษฎร์", "สมิติเวช สุขุมวิท", "กรุงเทพ", "พญาไท 2"],
                tone: "Professional, กระชับ, เน้นตัวเลขและผลตอบแทน",
                context: "เน้นการบริหารภาษี และการรักษาที่รวดเร็วใน รพ. ระดับ World Class"
            },
            "RH2": {
                name: "RH2: ภาคตะวันออก (EEC)",
                dynamics: "เขตเศรษฐกิจใหม่ นิคมอุตสาหกรรม เมืองท่องเที่ยว รายได้สูงแต่มีความเสี่ยง",
                keywords: ["ความเสี่ยงจากการทำงาน", "เงินก้อนหลังเกษียณไว", "สวัสดิการโรงงาน", "สวัสดิการเสริม"],
                hospitals: ["กรุงเทพพัทยา", "สมิติเวช ศรีราชา", "พญาไท ศรีราชา"],
                tone: "จริงใจ, เน้นความคุ้มค่า, ตรงไปตรงมา",
                context: "เน้นการสร้างรายได้เสริมจากสวัสดิการเดิมที่ไม่ครอบคลุมหลังออกจากงาน"
            },
            "RH3": {
                name: "RH3: ภาคเหนือ",
                dynamics: "สังคมผู้สูงอายุ วัฒนธรรมล้านนา ท่องเที่ยวเชิงวัฒนธรรม",
                keywords: ["บารมี", "ส่งต่อให้ลูกหลาน", "อยู่อย่างสง่างาม", "ความมั่นคงปลอดภัย"],
                hospitals: ["เชียงใหม่ ราม", "กรุงเทพเชียงใหม่", "ศรีพัฒน์"],
                tone: "นุ่มนวล, ให้เกียรติ, เน้นความสัมพันธ์ระยะยาว",
                context: "เน้นเรื่องมรดกและการดูแลสุขภาพในวัยเกษียณที่เป็นภาระลูกหลานให้น้อยที่สุด"
            },
            "RH4": {
                name: "RH4: ภาคตะวันออกเฉียงเหนือ",
                dynamics: "ครอบครัวขยาย เกษตรกรรมก้าวหน้า เสาหลักคนสำคัญ",
                keywords: ["ความกตัญญู", "พึ่งพาตัวเองได้", "ทุนการศึกษาลูก", "ไม่เป็นภาระใคร"],
                hospitals: ["กรุงเทพขอนแก่น", "เอกอุดร", "พริ้นซ์ อุบลราชธานี"],
                tone: "เป็นกันเอง, จริงใจเหมือนญาติ, เข้าถึงง่าย",
                context: "เน้นการปกป้องเสาหลักของบ้านที่มีความรับผิดชอบต่อคนจำนวนมาก"
            },
            "RH5": {
                name: "RH5: ภาคใต้",
                dynamics: "การประมง/สวนยาง/ท่องเที่ยว รายได้สูงเป็นช่วงเวลา",
                keywords: ["ใจนักเลง", "พวกพ้อง", "สภาพคล่อง", "การันตีรายได้"],
                hospitals: ["กรุงเทพหาดใหญ่", "กรุงเทพภูเก็ต", "สงขลานครินทร์ (SMC)"],
                tone: "หนักแน่น, ชัดเจน, จริงใจ, ไม่เยิ่นเย้อ",
                context: "เน้นการล็อกกำไรจากธุรกิจและการสร้างกระแสเงินสดที่สม่ำเสมอ"
            }
        };

        const ZONES = {
            "RH1": ["สาทร-สีลม", "สุขุมวิท", "ลาดพร้าว", "นนทบุรี", "สมุทรปราการ"],
            "RH2": ["ชลบุรี", "ศรีราชา-พัทยา", "ระยอง", "ฉะเชิงเทรา"],
            "RH3": ["เชียงใหม่", "เชียงราย", "พิษณุโลก", "นครสวรรค์"],
            "RH4": ["ขอนแก่น", "นครราชสีมา", "อุบลราชธานี", "อุดรธานี"],
            "RH5": ["หาดใหญ่", "ภูเก็ต", "สุราษฎร์ธานี", "นครศรีธรรมราช"]
        };

        // --- React-like Components without React ---
        class MAMAV2 {
            constructor() {
                this.state = {
                    apiKey: "",
                    isSetup: false,
                    userProfile: { agentName: "", rh: "", zone: "" },
                    activeTab: "needs_analysis",
                    loading: false,
                    aiResponse: "",
                    error: "",
                    feedback: null,
                    forms: {
                        needs_analysis: { income: "", expense: "", debt: "", dependents: "", years: "", assets: "" },
                        ice_breaking: { age: "", job: "", location: "", observation: "" },
                        objection: { type: "เงินไม่พอ", direct_quote: "" },
                        simplifier: { plan_name: "", benefits: "", premium: "" },
                        matchmaker: { goal: "ลดหย่อนภาษี", budget: "" },
                        closing: { interest_point: "", last_concern: "" },
                        prompt_designer: { objective: "", target: "", tone: "Professional", details: "" }
                    }
                };
                
                this.init();
            }
            
            setState(newState) {
                this.state = { ...this.state, ...newState };
                this.render();
            }
            
            handleInputChange(tab, field, value) {
                const forms = { ...this.state.forms };
                forms[tab][field] = value;
                this.setState({ forms });
            }
            
            calculateRealityCheck() {
                const f = this.state.forms.needs_analysis;
                const totalNeed = (Number(f.debt) || 0) + ((Number(f.expense) || 0) * 12 * (Number(f.years) || 1));
                const gap = Math.max(0, totalNeed - (Number(f.assets) || 0));
                const months = (Number(f.assets) || 0) / (Number(f.expense) || 1);
                return { gap, months };
            }
            
            getPowerPrompt() {
                const rh = RH_DATA[this.state.userProfile.rh];
                const zone = this.state.userProfile.zone;
                const commonContext = `Context: แนะนำตัวในฐานะ MAMA AI สำหรับตัวแทนชื่อ ${this.state.userProfile.agentName} ในพื้นที่ ${zone} (${rh.name}). 
                Local Dynamics: ${rh.dynamics}. 
                Local Keywords: ${rh.keywords.join(", ")}. (AI ต้องนำคำเหล่านี้ไปผสมในบทพูดอย่างน้อย 1-2 คำ).
                Top Hospitals for Reference: ${rh.hospitals.join(", ")}.`;
                
                const forms = this.state.forms;
                
                switch (this.state.activeTab) {
                    case "needs_analysis":
                        const { gap, months } = this.calculateRealityCheck();
                        return `${commonContext} 
                        Task: คุณคือที่ปรึกษาการเงินระดับ CFP วิเคราะห์ Protection Gap จากข้อมูล: รายได้ ${forms.needs_analysis.income}, รายจ่าย ${forms.needs_analysis.expense}, หนี้ ${forms.needs_analysis.debt}.
                        Instruction: จงคำนวณ 'ระยะเวลาอยู่รอด' (ผลลัพธ์คือ ${months.toFixed(1)} เดือน) และสร้าง Financial Reality Check ที่กระตุกความคิดลูกค้า โดยใช้การเปรียบเทียบ (Metaphor) ที่คนในพื้นที่เข้าใจง่าย เช่น เปรียบเทียบทุนประกันที่ขาด ${gap.toLocaleString()} บาท กับทรัพย์สินท้องถิ่น`;
                    
                    case "ice_breaking":
                        return `${commonContext}
                        Task: คุณคือผู้เชี่ยวชาญด้านจิตวิทยาการสื่อสาร สร้างบทสนทนาเปิดใจ 3 รูปแบบ (ทั่วไป, เชื่อมโยงอาชีพ, Hook เปิดใจ) สำหรับลูกค้าอายุ ${forms.ice_breaking.age} อาชีพ ${forms.ice_breaking.job} พบกันที่ ${forms.ice_breaking.location}.
                        Instruction: ใช้ 'Local Common Ground' ใน ${zone} (ข่าวเศรษฐกิจ, เทศกาล, หรือแลนด์มาร์ค) เพื่อทำลายกำแพง Tone ต้องเป็น ${rh.tone}`;
                    
                    case "objection":
                        return `${commonContext}
                        Task: คุณคือนักเจรจาต่อรองมือหนึ่ง ใช้เทคนิค LSCPA แก้ข้อโต้แย้ง: "${forms.objection.type}" จากคำพูดลูกค้า: "${forms.objection.direct_quote}".
                        Instruction: ห้ามโต้เถียงแต่ให้ใช้ 'Reframing' เปรียบเทียบความคุ้มค่ากับความเสี่ยงที่คนในโซน ${zone} มักเจอ (เช่น อุบัติเหตุโรงงาน หรือสวัสดิการข้าราชการไม่พอ)`;
                    
                    case "simplifier":
                        return `${commonContext}
                        Task: คุณคือ Content Creator ย่อยผลประโยชน์ประกันแผน ${forms.simplifier.plan_name} เบี้ย ${forms.simplifier.premium} ให้เหลือ '3 ประโยคทองคำ'.
                        Instruction: เปรียบเทียบเบี้ยประกันรายวันกับ 'ค่าครองชีพใน ${zone}' (เช่น กาแฟร้านดัง, ข้าวแกง, หรือตั๋วเรือ) เพื่อให้เห็นว่าเบี้ยเล็กน้อยมาก`;
                    
                    case "matchmaker":
                        return `${commonContext}
                        Task: คุณคือนักออกแบบแผนประกันมืออาชีพ เลือก Solution สำหรับเป้าหมาย ${forms.matchmaker.goal} งบ ${forms.matchmaker.budget}.
                        Instruction: อ้างอิงสวัสดิการที่คนใน ${zone} มักจะมีอยู่แล้ว และชี้ให้เห็นว่าแผนนี้เติมเต็มส่วนขาดอย่างไร`;
                    
                    case "closing":
                        return `${commonContext}
                        Task: คุณคือ Top Sales (MDRT) สรุปจุดเด่นที่ลูกค้าชอบ: ${forms.closing.interest_point} และแก้กังวล: ${forms.closing.last_concern}.
                        Instruction: ใช้เทคนิค Alternative Close และใช้ 'ความเร่งด่วนเชิงพื้นที่' (เช่น สิทธิพิเศษ รพ. ${rh.hospitals[0]} หรือโควต้า) ร่างบทพูดปิดการขายที่นุ่มนวลแต่ทรงพลัง`;
                    
                    case "prompt_designer":
                        return `Role: คุณคือเชี่ยวชาญด้าน Prompt Engineering ระดับโลกที่เข้าใจธุรกิจประกันไทย
                        Objective: ${forms.prompt_designer.objective}
                        Target: ${forms.prompt_designer.target}
                        Tone: ${forms.prompt_designer.tone}
                        Details: ${forms.prompt_designer.details}
                        Context: ${zone}, ${rh.name}, Hospitals: ${rh.hospitals.join(", ")}
                        Task: ออกแบบ 'Master Prompt' (Structure: Context + Role + Task + Constraint) ฝังข้อมูล Localized ลงไป
                        Output Format: 
                        1. วิเคราะห์ความตั้งใจ 
                        2. Master Prompt (ในกรอบ Code) 
                        3. เคล็ดลับการปรับจูน`;
                    
                    default: return "";
                }
            }
            
            async handleGenerate() {
                if (!this.state.apiKey) {
                    this.setState({ error: "กรุณาระบุ API Key" });
                    return;
                }
                
                this.setState({ loading: true, aiResponse: "", error: "" });
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.state.apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: this.getPowerPrompt() }] }] }),
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    this.setState({ 
                        aiResponse: data.candidates?.[0]?.content?.parts?.[0]?.text || "ไม่พบคำตอบ" 
                    });
                } catch (err) {
                    this.setState({ error: err.message });
                } finally {
                    this.setState({ loading: false });
                }
            }
            
            // --- Rendering Methods ---
            
            renderInputSection() {
                const tab = this.state.activeTab;
                const f = this.state.forms[tab];
                
                const InputWrap = (label, children) => `
                    <div class="mb-4">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">${label}</label>
                        ${children}
                    </div>
                `;
                
                switch (tab) {
                    case "needs_analysis":
                        const { gap } = this.calculateRealityCheck();
                        return `
                            <div class="space-y-4 animate-in">
                                <div class="grid grid-cols-2 gap-3">
                                    ${InputWrap("รายได้ต่อปี (บาท)", `
                                        <input type="number" 
                                            class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                            value="${f.income}" 
                                            onchange="app.handleInputChange('needs_analysis', 'income', this.value)"
                                            placeholder="0">
                                    `)}
                                    ${InputWrap("รายจ่าย/เดือน", `
                                        <input type="number" 
                                            class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                            value="${f.expense}" 
                                            onchange="app.handleInputChange('needs_analysis', 'expense', this.value)"
                                            placeholder="0">
                                    `)}
                                </div>
                                ${InputWrap("หนี้สินรวม (บ้าน/รถ/ธุรกิจ)", `
                                    <input type="number" 
                                        class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                        value="${f.debt}" 
                                        onchange="app.handleInputChange('needs_analysis', 'debt', this.value)"
                                        placeholder="0">
                                `)}
                                <div class="grid grid-cols-2 gap-3">
                                    ${InputWrap("คนในอุปการะ", `
                                        <input type="number" 
                                            class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                            value="${f.dependents}" 
                                            onchange="app.handleInputChange('needs_analysis', 'dependents', this.value)"
                                            placeholder="คน">
                                    `)}
                                    ${InputWrap("จำนวนปีที่ต้องดูแล", `
                                        <input type="number" 
                                            class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                            value="${f.years}" 
                                            onchange="app.handleInputChange('needs_analysis', 'years', this.value)"
                                            placeholder="ปี">
                                    `)}
                                </div>
                                ${InputWrap("สินทรัพย์เดิม (เงินออม/ทุนประกัน)", `
                                    <input type="number" 
                                        class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                        value="${f.assets}" 
                                        onchange="app.handleInputChange('needs_analysis', 'assets', this.value)"
                                        placeholder="0">
                                `)}
                                <div class="bg-gradient-to-r from-sky-900 to-indigo-900 rounded-xl p-4 text-white shadow-lg">
                                    <div class="flex justify-between items-center text-[10px] opacity-80 mb-1">
                                        <span>ESTIMATED PROTECTION GAP</span>
                                        <span>${AlertCircle({ size: 12 }).outerHTML}</span>
                                    </div>
                                    <div class="text-xl font-bold">${gap.toLocaleString()} บาท</div>
                                </div>
                            </div>
                        `;
                    
                    case "ice_breaking":
                        return `
                            <div class="space-y-4 animate-in">
                                <div class="grid grid-cols-2 gap-3">
                                    ${InputWrap("ช่วงอายุลูกค้า", `
                                        <input type="text" 
                                            class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                            value="${f.age}" 
                                            onchange="app.handleInputChange('ice_breaking', 'age', this.value)"
                                            placeholder="เช่น 35-40 ปี">
                                    `)}
                                    ${InputWrap("อาชีพ", `
                                        <input type="text" 
                                            class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                            value="${f.job}" 
                                            onchange="app.handleInputChange('ice_breaking', 'job', this.value)"
                                            placeholder="เช่น วิศวกร">
                                    `)}
                                </div>
                                ${InputWrap("สถานที่ที่พบกัน", `
                                    <input type="text" 
                                        class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm" 
                                        value="${f.location}" 
                                        onchange="app.handleInputChange('ice_breaking', 'location', this.value)"
                                        placeholder="เช่น ร้านกาแฟในนิคมฯ">
                                `)}
                                ${InputWrap("สิ่งที่สังเกตเห็น (Insight)", `
                                    <textarea 
                                        class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm h-24 resize-none" 
                                        onchange="app.handleInputChange('ice_breaking', 'observation', this.value)"
                                        placeholder="เช่น ใส่สมาร์ทวอทช์, ดูรีบไปรับลูก, ถือหนังสือลงทุน">${f.observation}</textarea>
                                `)}
                            </div>
                        `;
                    
                    // ... (similar for other tabs - keeping it concise)
                    default:
                        return `<div>Input section for ${tab}</div>`;
                }
            }
            
            renderSetupPage() {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-950 flex items-center justify-center p-6">
                        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 overflow-hidden relative">
                            <div class="absolute top-0 right-0 p-4 opacity-5">
                                ${Sparkles({ size: 120 })}
                            </div>
                            
                            <div class="flex flex-col items-center mb-8 relative">
                                <div class="w-16 h-16 bg-gradient-to-br from-sky-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl">
                                    ${Sparkles({ size: 32 })}
                                </div>
                                <h1 class="text-3xl font-black text-slate-900 tracking-tight">MAMA V.2</h1>
                                <p class="text-[10px] bg-gradient-to-r from-sky-600 to-indigo-600 bg-clip-text text-transparent font-bold tracking-[0.2em] uppercase mt-1">AI Sale Assistant</p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">API KEY</label>
                                    <input type="password" 
                                        value="${this.state.apiKey}" 
                                        onchange="app.setState({ apiKey: this.value })"
                                        placeholder="Gemini API Key..." 
                                        class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-sky-500 outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">AGENT NAME</label>
                                    <input type="text" 
                                        value="${this.state.userProfile.agentName}" 
                                        onchange="app.setState({ userProfile: { ...app.state.userProfile, agentName: this.value } })"
                                        placeholder="ชื่อตัวแทน..." 
                                        class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-sky-500 outline-none transition-all">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">REGION (RH)</label>
                                        <select 
                                            value="${this.state.userProfile.rh}" 
                                            onchange="app.setState({ userProfile: { ...app.state.userProfile, rh: this.value, zone: '' } })"
                                            class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-sky-500 outline-none">
                                            <option value="">เลือก RH</option>
                                            ${Object.keys(RH_DATA).map(rh => `<option value="${rh}">${rh}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">ZONE</label>
                                        <select 
                                            value="${this.state.userProfile.zone}" 
                                            onchange="app.setState({ userProfile: { ...app.state.userProfile, zone: this.value } })"
                                            ${!this.state.userProfile.rh ? 'disabled' : ''}
                                            class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-sky-500 outline-none ${!this.state.userProfile.rh ? 'bg-slate-50' : ''}">
                                            <option value="">เลือกโซน</option>
                                            ${this.state.userProfile.rh ? ZONES[this.state.userProfile.rh].map(z => `<option value="${z}">${z}</option>`).join('') : ''}
                                        </select>
                                    </div>
                                </div>
                                
                                <button 
                                    onclick="if(app.state.apiKey && app.state.userProfile.agentName && app.state.userProfile.zone) app.setState({ isSetup: true }); else alert('กรุณากรอกข้อมูลให้ครบ')"
                                    class="w-full bg-gradient-to-r from-sky-600 to-indigo-600 hover:from-sky-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl transition-all mt-4 flex items-center justify-center gap-2 shadow-lg shadow-sky-900/20">
                                    Start Copilot ${ChevronRight({ size: 18 })}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderMainPage() {
                const tabs = [
                    { id: 'needs_analysis', label: '1. วิเคราะห์ความต้องการ', icon: Calculator },
                    { id: 'ice_breaking', label: '2. บทสนทนาเปิดใจ', icon: MessageSquare },
                    { id: 'objection', label: '3. ทลายข้อโต้แย้ง', icon: ShieldAlert },
                    { id: 'simplifier', label: '4. ย่อยผลประโยชน์', icon: Gift },
                    { id: 'matchmaker', label: '5. เลือกผลิตภัณฑ์', icon: ShoppingBag },
                    { id: 'closing', label: '6. สรุปและปิดการขาย', icon: FileCheck },
                    { id: 'prompt_designer', label: '7. Prompt Designer', icon: Terminal },
                ];
                
                const rh = RH_DATA[this.state.userProfile.rh];
                
                return `
                    <div class="min-h-screen bg-slate-50 flex flex-col md:flex-row overflow-hidden">
                        <!-- Sidebar -->
                        <aside class="w-full md:w-72 bg-gradient-to-b from-slate-900 to-slate-950 text-white flex flex-col flex-shrink-0 z-30 shadow-2xl">
                            <div class="p-6 border-b border-white/5 flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-sky-500 to-indigo-600 rounded-xl flex items-center justify-center text-white">
                                    ${Sparkles({ size: 24 })}
                                </div>
                                <div>
                                    <span class="font-black text-xl block leading-none">MAMA <span class="bg-gradient-to-r from-sky-400 to-indigo-400 bg-clip-text text-transparent">V.2</span></span>
                                    <span class="text-[8px] text-slate-500 font-bold tracking-[0.2em]">PRU ACADEMY [ttb]</span>
                                </div>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto p-4 space-y-1.5 custom-scrollbar">
                                ${tabs.map(tab => `
                                    <button
                                        onclick="app.setState({ activeTab: '${tab.id}', aiResponse: '' })"
                                        class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl transition-all group ${this.state.activeTab === tab.id ? 'bg-gradient-to-r from-sky-600 to-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                                        ${tab.icon({ size: 18, class: this.state.activeTab === tab.id ? 'text-white' : 'text-sky-400' })}
                                        <span class="text-[13px] font-bold">${tab.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <div class="p-4 bg-black/20 border-t border-white/5">
                                <div class="bg-slate-800/50 rounded-2xl p-4 relative overflow-hidden">
                                    <div class="text-[10px] text-slate-500 font-bold mb-2 flex items-center gap-1 uppercase">
                                        ${MapPin({ size: 10 })} ${this.state.userProfile.zone}
                                    </div>
                                    <div class="text-xs font-bold mb-1 truncate">${rh.name}</div>
                                    <div class="text-[10px] text-slate-400 italic">"${rh.tone}"</div>
                                    <button onclick="app.setState({ isSetup: false })" class="absolute top-2 right-2 text-slate-600 hover:text-sky-400">
                                        ${RotateCcw({ size: 14 })}
                                    </button>
                                </div>
                            </div>
                        </aside>
                        
                        <!-- Main Content -->
                        <main class="flex-1 flex flex-col overflow-hidden relative">
                            <!-- Header -->
                            <header class="bg-white px-8 py-5 border-b flex justify-between items-center z-10">
                                <div>
                                    <h2 class="text-xl font-black text-slate-800 flex items-center gap-2">
                                        ${this.state.activeTab.replace('_', ' ').toUpperCase()}
                                    </h2>
                                    <div class="flex gap-2 mt-1">
                                        ${rh.keywords.slice(0, 2).map(k => `
                                            <span class="text-[9px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold">#${k}</span>
                                        `).join('')}
                                    </div>
                                </div>
                                <button 
                                    onclick="app.handleGenerate()"
                                    ${this.state.loading ? 'disabled' : ''}
                                    class="px-8 py-3 rounded-xl font-black transition-all flex items-center gap-2 shadow-xl ${this.state.loading ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-gradient-to-r from-sky-600 to-indigo-600 text-white hover:from-sky-700 hover:to-indigo-700 shadow-sky-900/10'}">
                                    ${this.state.loading ? Loader2({ class: 'spinner', size: 18 }) : Sparkles({ size: 18 })}
                                    ${this.state.loading ? 'ANALYZING...' : 'AI วิเคราะห์'}
                                </button>
                            </header>
                            
                            <div class="flex-1 flex overflow-hidden">
                                <!-- Left: Input Panel -->
                                <div class="w-80 bg-white border-r overflow-y-auto p-6 flex-shrink-0 custom-scrollbar">
                                    <div class="mb-6 flex items-center justify-between">
                                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Client Inputs</h4>
                                        ${TrendingUp({ size: 14, class: 'text-slate-200' })}
                                    </div>
                                    <div id="input-section">
                                        ${this.renderInputSection()}
                                    </div>
                                    
                                    <!-- Region Insights -->
                                    <div class="mt-8 pt-8 border-t space-y-4">
                                        <div class="flex items-center gap-2 bg-gradient-to-r from-sky-600 to-indigo-600 bg-clip-text text-transparent">
                                            ${Building2({ size: 16 })}
                                            <span class="text-[10px] font-black uppercase tracking-wider">Local Insight</span>
                                        </div>
                                        <div class="p-4 bg-slate-50 rounded-2xl border">
                                            <p class="text-xs text-slate-600 leading-relaxed italic">"${rh.dynamics}"</p>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                                                ${Stethoscope({ size: 16 })}
                                                <span class="text-[10px] font-black uppercase tracking-wider">Top Hospitals</span>
                                            </div>
                                            <div class="flex flex-wrap gap-1.5">
                                                ${rh.hospitals.map(h => `
                                                    <span class="text-[9px] bg-white border px-2 py-1 rounded-lg text-slate-500 font-bold">${h}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right: Output Panel -->
                                <div class="flex-1 bg-gradient-to-br from-slate-50 to-white overflow-y-auto custom-scrollbar relative">
                                    ${this.renderOutputPanel()}
                                </div>
                            </div>
                        </main>
                    </div>
                `;
            }
            
            renderOutputPanel() {
                if (!this.state.aiResponse) {
                    return `
                        <div class="h-full flex flex-col items-center justify-center opacity-20 select-none px-12 text-center py-12">
                            <div class="w-32 h-32 bg-gradient-to-br from-slate-200 to-slate-300 rounded-full flex items-center justify-center mb-6 shadow-inner">
                                ${Sparkles({ size: 64, class: 'text-slate-400' })}
                            </div>
                            <h3 class="text-3xl font-black tracking-tight bg-gradient-to-r from-slate-400 to-slate-600 bg-clip-text text-transparent">MAMA READY</h3>
                            <p class="mt-2 text-slate-500 max-w-sm">
                                กรอกข้อมูลในช่อง Input ทางซ้าย แล้วกด "AI วิเคราะห์" เพื่อดึงข้อมูลเชิงพื้นที่และเทคนิคการขายระดับ MDRT
                            </p>
                            ${this.state.error ? `
                                <div class="mt-8 p-4 bg-red-50 text-red-600 border border-red-200 rounded-2xl text-xs font-bold w-full max-w-md">
                                    ERROR: ${this.state.error}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="max-w-3xl mx-auto p-8 lg:p-12 pb-32 slide-in-from-bottom">
                        <!-- Result Wrapper -->
                        <div class="bg-white rounded-[2rem] shadow-2xl shadow-slate-200 overflow-hidden border border-white">
                            <!-- Result Header -->
                            <div class="bg-gradient-to-r from-sky-600 to-indigo-600 px-10 py-6 text-white flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                                        ${Lightbulb({ size: 24 })}
                                    </div>
                                    <div>
                                        <div class="text-[10px] font-bold text-sky-300 uppercase tracking-[0.2em]">AI SUGGESTION</div>
                                        <div class="text-sm font-bold opacity-90">${this.state.activeTab.replace('_', ' ').toUpperCase()}</div>
                                    </div>
                                </div>
                                <button onclick="navigator.clipboard.writeText('${this.state.aiResponse.replace(/'/g, "\\'")}'); alert('คัดลอกลง Clipboard แล้ว');" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-xl flex items-center justify-center transition-colors backdrop-blur-sm">
                                    ${Copy({ size: 18 })}
                                </button>
                            </div>
                            
                            <!-- Result Content -->
                            <div class="p-10 text-slate-700 leading-relaxed text-sm md:text-base whitespace-pre-line">
                                ${this.state.aiResponse.replace(/\n/g, '<br>')}
                            </div>
                            
                            <!-- Rating -->
                            <div class="bg-slate-50 p-6 border-t flex justify-center items-center gap-6">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Helpful?</span>
                                <div class="flex gap-4">
                                    <button onclick="app.setState({ feedback: 'up' })" class="w-12 h-12 rounded-full flex items-center justify-center border transition-all ${this.state.feedback === 'up' ? 'bg-gradient-to-br from-emerald-500 to-green-500 text-white border-emerald-500' : 'bg-white text-slate-300 hover:text-emerald-500'}">
                                        ${ThumbsUp({ size: 20 })}
                                    </button>
                                    <button onclick="app.setState({ feedback: 'down' })" class="w-12 h-12 rounded-full flex items-center justify-center border transition-all ${this.state.feedback === 'down' ? 'bg-gradient-to-br from-rose-500 to-pink-500 text-white border-rose-500' : 'bg-white text-slate-300 hover:text-rose-500'}">
                                        ${ThumbsDown({ size: 20 })}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer Buttons -->
                        <div class="mt-8 flex flex-wrap justify-center gap-3">
                            <button class="bg-white border text-slate-600 px-6 py-3 rounded-xl text-xs font-bold hover:bg-slate-50 flex items-center gap-2 shadow-sm">
                                ${Share2({ size: 14 })} ส่งเข้า Line
                            </button>
                            <button class="bg-white border text-slate-600 px-6 py-3 rounded-xl text-xs font-bold hover:bg-slate-50 flex items-center gap-2 shadow-sm">
                                ${Save({ size: 14 })} บันทึกเคส
                            </button>
                        </div>
                    </div>
                `;
            }
            
            render() {
                const root = document.getElementById('root');
                if (!root) return;
                
                root.innerHTML = this.state.isSetup ? this.renderMainPage() : this.renderSetupPage();
                
                // Re-attach lucide icons
                if (window.lucide.createIcons) {
                    window.lucide.createIcons();
                }
            }
            
            init() {
                this.render();
                // Initialize lucide icons
                if (window.lucide.createIcons) {
                    window.lucide.createIcons();
                }
            }
        }

        // Initialize the app
        window.app = new MAMAV2();
    </script>
</body>
</html>
